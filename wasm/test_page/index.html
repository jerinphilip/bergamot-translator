<!DOCTYPE html>
<html>
  <head>
    <title>Mozilla Translations</title>
    <link rel="stylesheet" href="css/index.css" />
    <link rel="stylesheet" href="css/attention.css"/>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <script src="js/d3.v4.min.js"></script>
  </head>
  <body>
    <div class="app">
      <div class="panel panel--from">
        <label>
          From
          <select id="lang-from" name="from" class="lang-select"></select>
        </label>
        <textarea id="input" name="input"></textarea>
      </div>
      <button class="swap" title="swap">↔️</button>
      <div class="panel panel--to">
        <label>
          To
          <select id="lang-to" name="to" class="lang-select"></select>
        </label>
        <div id="output" class="output-area"></div>
      </div>
      <div class="footer" id="status"></div>
    <script src="js/index.js"></script>
    </div>
        <figure id="attentional-ex2" class="l-page">
            <pre id="attentional-ex2-data" style="display: none;">0.50, 0.02, 0.04, 0.00, 0.00, 0.00, 0.00, 0.00, 0.01, 0.01, 0.00, 0.00, 0.00, 0.05, 0.05
0.14, 0.89, 0.07, 0.00, 0.00, 0.00, 0.00, 0.00, 0.01, 0.06, 0.00, 0.00, 0.00, 0.02, 0.00
0.02, 0.00, 0.56, 0.00, 0.00, 0.00, 0.00, 0.01, 0.00, 0.00, 0.00, 0.00, 0.00, 0.02, 0.00
0.00, 0.00, 0.01, 0.61, 0.02, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
0.00, 0.00, 0.02, 0.03, 0.01, 0.21, 0.97, 0.05, 0.00, 0.00, 0.00, 0.00, 0.00, 0.01, 0.00
0.00, 0.00, 0.02, 0.07, 0.25, 0.76, 0.02, 0.04, 0.00, 0.00, 0.00, 0.00, 0.00, 0.02, 0.00
0.02, 0.04, 0.03, 0.27, 0.71, 0.02, 0.00, 0.02, 0.00, 0.00, 0.02, 0.00, 0.00, 0.05, 0.01
0.02, 0.00, 0.07, 0.00, 0.00, 0.00, 0.00, 0.60, 0.40, 0.01, 0.04, 0.00, 0.00, 0.13, 0.01
0.13, 0.02, 0.02, 0.00, 0.01, 0.00, 0.00, 0.23, 0.52, 0.91, 0.07, 0.00, 0.00, 0.10, 0.00
0.04, 0.00, 0.01, 0.00, 0.00, 0.00, 0.00, 0.01, 0.03, 0.00, 0.67, 0.00, 0.00, 0.16, 0.02
0.02, 0.00, 0.04, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.14, 0.96, 0.00, 0.02, 0.07
0.02, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.02, 0.02, 1.00, 0.02, 0.03
0.02, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.01, 0.00, 0.01, 0.00, 0.00, 0.32, 0.11
0.04, 0.00, 0.08, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.01, 0.00, 0.00, 0.04, 0.67</pre>
            <svg>
                <defs>
                <marker id="edgeArrowhead" viewBox="0 -5 10 10" markerWidth="6" markerHeight="10" orient="auto" refX="5" refY="0">
                <path d="M0,-5L5,0L0,5" fill="none" stroke="#666"></path>
                </marker>
                <marker id="edgeArrowheadLeft" viewBox="0 -5 10 10" markerWidth="6" markerHeight="10" orient="auto" refX="0" refY="0">
                <path d="M5,-5L0,0L5,5" fill="none" stroke="#666"></path>
                </marker>
                </defs>
                <g class="labels" style="display: none;">
                <text transform="translate(0, 20)">output text</text>
                <text transform="translate(0, 65)">network B</text>
                <text transform="translate(0, 185)">network A</text>
                <text transform="translate(0, 233)">input text</text>
                </g>
            </svg>
            <figcaption>Diagram derived from Fig. 3 of <a href="https://arxiv.org/pdf/1409.0473.pdf">Bahdanau, <i>et al.</i> 2014</a></figcaption>
        </figure>

        <script>
            (function() {

                var labelsA = [
                    "the",
                    "agreement",
                    "on",
                    "the",
                    "European",
                    "Economic",
                    "Area",
                    "was",
                    "signed",
                    "in",
                    "August",
                    "1992",
                    ".",
                    "<end>"
                ];

                var labelsB = [
                    "l’",
                    "accord",
                    "sur",
                    "la",
                    "zone",
                    "économique",
                    "européenne",
                    "a",
                    "été",
                    "signé",
                    "en",
                    "août",
                    "1992",
                    ".",
                    "<end>"
                ];

                var data = d3.csvParseRows(d3.select("#attentional-ex2-data").text());
                // console.log(data)
                var linkData = [];
                data.forEach(function(a, ai) {
                    a.forEach(function(b, bi) {
                        linkData.push({
                            ai: +ai,
                            bi: +bi,
                            v: +data[ai][bi]
                        });
                    });
                });

                var nodeMargin = 10;
                var networkMargin = 120;

                var html = d3.select("#attentional-ex2");
                var outerWidth = 984;//html.node().getBoundingClientRect().width;
                var outerHeight = 240;//html.node().getBoundingClientRect().height;
                var margin = {top: 36, right: nodeMargin, bottom: 24, left: nodeMargin};
                var width = outerWidth - margin.left - margin.right;
                var height = outerHeight - margin.top - margin.bottom;

                var xa = d3.scaleBand()
                    .domain(d3.range(labelsA.length))
                    .paddingInner(0.5)
                    .range([nodeMargin, width - nodeMargin]);

                var xb = d3.scaleBand()
                    .domain(d3.range(labelsB.length))
                    .paddingInner(0.5)
                    .range([nodeMargin, width - nodeMargin]);

                var nodeSizeA = xa.bandwidth();
                var nodeSizeB = xb.bandwidth();

                var networkHeightA = nodeSizeA + nodeMargin * 2;
                var networkHeightB = nodeSizeB + nodeMargin * 2;

                var link = function(d) {
                    // console.log(nodeSizeB, nodeSizeA, nodeMargin, d.bi, xb(d.bi))
                    var p = "M" + (xb(d.bi) + nodeSizeB / 2) + "," + (nodeSizeB + nodeMargin)
                        + "C" + (xb(d.bi) + nodeSizeB / 2) + "," + (nodeSizeB + networkMargin / 3 + nodeMargin)
                        + " " + (xa(d.ai) + nodeSizeA / 2) + "," + (networkMargin - networkMargin / 3 + nodeMargin)
                        + " " + (xa(d.ai) + nodeSizeA / 2) + "," + (networkMargin + nodeMargin);
                    // console.log(p);
                    return p;
                };

                html.select("svg .labels")
                    .attr("transform", "translate(" + (width + nodeMargin * 3) + ", 0)");

                var svg = html.select("svg")
                    .attr("viewBox", "0 0 " + outerWidth + " " + outerHeight)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var networkA = svg.append("g")
                    .attr("transform", "translate(0, " + networkMargin + ")");

                networkA.append("rect")
                    .attr("class", "background")
                    .attr("width", width)
                    .attr("height", nodeSizeA + 2 * nodeMargin)
                    .attr("rx", nodeMargin * 0.7)
                    .attr("ry", nodeMargin * 0.7);

                var cellA = networkA.selectAll(".cell")
                    .data(labelsA)
                    .enter().append("g")
                    .attr("class", "cell")
                    .attr("transform", function(d, i) { return "translate(" + xa(i) + ", " + nodeMargin + ")"; })
                    .on("mouseover", function(d, i) {
                        link.style("display", function(ld) {
                            return ld.ai === i ? "" : "none";
                        });
                    })
                    .on("mouseout", function() { link.style("display", ""); });

                cellA.append("rect")
                    .attr("class", "shadow")
                    .attr("transform", "translate(1, 3)")
                    .attr("width", nodeSizeA)
                    .attr("height", nodeSizeA)
                    .attr("rx", 4)
                    .attr("ry", 4);

                cellA.append("rect")
                    .attr("class", "node")
                    .attr("width", nodeSizeA)
                    .attr("height", nodeSizeA)
                    .attr("rx", 4)
                    .attr("ry", 4);

                cellA.append("line")
                    .attr("class", "arrow")
                    .attr("marker-start", "url(#edgeArrowheadLeft)")
                    .attr("marker-end", "url(#edgeArrowhead)")
                    .attr("x1", nodeSizeA + 8)
                    .attr("x2", nodeSizeA + nodeMargin + 20)
                    .attr("y1", nodeSizeA / 2)
                    .attr("y2", nodeSizeA / 2);

                cellA.append("line")
                    .attr("class", "arrow")
                    .attr("marker-end", "url(#edgeArrowhead)")
                    .attr("transform", "translate(" + nodeSizeA / 2 + ", 0)")
                    .attr("y1", nodeSizeA + nodeMargin * 2 - 2)
                    .attr("y2", nodeSizeA + 4);

                cellA.append("text")
                    .style("opacity", 0.8)
                    .text("A")
                    .attr("dx", nodeSizeA / 2)
                    .attr("dy", nodeSizeA / 2 + 1);

                cellA.append("text")
                    .attr("class", "label")
                    .attr("dx", nodeSizeA / 2)
                    .attr("dy", nodeSizeA + 24 + 8)
                    .text(function(d) { return d; });

                cellA.append("rect")
                    .style("opacity", 0)
                    .attr("transform", "translate(-" + ((xa.step() - nodeSizeA) / 2) + ",-" + (nodeMargin + (networkMargin - networkHeightB) / 2) + ")")
                    .attr("width", xa.step())
                    .attr("height", networkHeightA + (networkMargin - networkHeightA) / 2);

                //
                // Network B
                //

                var networkB = svg.append("g");

                networkB.append("rect")
                    .attr("class", "background")
                    .attr("width", width)
                    .attr("height", nodeSizeB + 2 * nodeMargin)
                    .attr("rx", nodeMargin * 0.7)
                    .attr("ry", nodeMargin * 0.7);

                var cellB = networkB.selectAll(".cell")
                    .data(labelsB)
                    .enter().append("g")
                    .attr("class", "cell")
                    .attr("transform", function(d, i) { return "translate(" + xb(i) + "," + nodeMargin + ")"; })
                    .on("mouseover", function(d, i) {
                        link.style("display", function(ld) {
                            return ld.bi === i ? "" : "none";
                        });
                    })
                    .on("mouseout", function() { link.style("display", ""); });

                cellB.append("rect")
                    .attr("class", "shadow")
                    .attr("transform", "translate(1, 3)")
                    .attr("width", nodeSizeB)
                    .attr("height", nodeSizeB)
                    .attr("rx", 4)
                    .attr("ry", 4);

                cellB.append("rect")
                    .attr("class", "node")
                    .attr("width", nodeSizeB)
                    .attr("height", nodeSizeB)
                    .attr("rx", 4)
                    .attr("ry", 4);

                cellB.append("line")
                    .attr("class", "arrow")
                    .attr("marker-end", "url(#edgeArrowhead)")
                    .attr("x1", nodeSizeB)
                    .attr("x2", nodeSizeB + nodeMargin + 14)
                    .attr("y1", nodeSizeB / 2)
                    .attr("y2", nodeSizeB / 2);

                cellB.append("line")
                    .attr("class", "arrow")
                    .attr("marker-end", "url(#edgeArrowhead)")
                    .attr("transform", "translate(" + nodeSizeB / 2 + ", 0)")
                    .attr("y1", 0)
                    .attr("y2", -nodeMargin * 2 + 5);

                cellB.append("text")
                    .style("opacity", 0.8)
                    .text("B")
                    .attr("dx", nodeSizeB / 2)
                    .attr("dy", nodeSizeB / 2 + 1);

                cellB.append("text")
                    .attr("class", "label")
                    .attr("dx", function(d) { return d === "européenne" ? nodeSizeB / 2 + 15 : nodeSizeB / 2; })
                    .attr("dy", - 24 - 5)
                    .text(function(d) { return d; });

                cellB.append("rect")
                    .style("opacity", 0)
                    .attr("transform", "translate(-" + ((xb.step() - nodeSizeB) / 2) + ",-" + nodeMargin + ")")
                    .attr("width", xb.step())
                    .attr("height", networkHeightB + (networkMargin - networkHeightB) / 2);
                //
                // Links
                //
                var linkGroup = svg.append("g").attr("class", ".link-group")

                var link = linkGroup.selectAll(".link")
                    .data(linkData)
                    .enter().append("path")
                    .attr("class", "link")
                    .attr("d", link)
                    .style("opacity", function(d) { return d.v; });
                //
                //
                //
                // var hoverB = svg.selectAll(".hover-b")
                //     .data(labelsB)
                //   .enter().append("rect")
                //     .attr("class", "hover-b")
                //     .style("opacity", 0)
                //     .attr("transform", function(d, i) { return "translate(" + (xb(i) - xb.step() / 4) + ", 0)"; })
                //     .attr("width", xb.step())
                //     .attr("height", networkMargin / 2 + nodeSizeB)


            })();</script>

        <p>This kind of attention between RNNs has a number of other applications. It can be used in voice recognition <dt-cite key="chan2015listen"><span id="citation-9" data-hover-ref="dt-cite-hover-box-9"><span class="citation-number">[12]</span></span></dt-cite>, allowing one RNN to process the audio and then have another RNN skim over it, focusing on relevant parts as it generates a transcript.</p>
                </div>
            </div>
        </div>

  </body>
</html>
